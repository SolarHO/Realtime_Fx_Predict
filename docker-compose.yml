networks: { fxnet: {} }
volumes: { pg_data: {}, kafka_data: {}, superset_home: {}, minio_data: {} }

services:
  kafka:
    image: confluentinc/cp-kafka:7.6.1
    container_name: kafka
    restart: unless-stopped
    networks: [fxnet]
    ports: ["9092:9092"]
    environment:
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_NODE_ID=${KAFKA_NODE_ID}
      - KAFKA_CONTROLLER_QUORUM_VOTERS=${KAFKA_NODE_ID}@kafka:9093
      - KAFKA_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093,INTERNAL://:19092
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://${KAFKA_ADVERTISED_ADDR}:9092,INTERNAL://kafka:19092
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT,INTERNAL:PLAINTEXT
      - KAFKA_NUM_PARTITIONS=${KAFKA_NUM_PARTITIONS}
      - KAFKA_LOG_RETENTION_HOURS=${KAFKA_RETENTION_HOURS}
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=0
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_INTER_BROKER_LISTENER_NAME=INTERNAL
      - KAFKA_LOG_DIRS=/var/lib/kafka/data
      - KAFKA_HEAP_OPTS=${KAFKA_HEAP}
      - CLUSTER_ID=${CLUSTER_ID}
    volumes: [ "kafka_data:/var/lib/kafka" ]

  postgres:
    image: postgres:15-alpine
    container_name: postgres
    restart: unless-stopped
    networks: [fxnet]
    ports: ["5432:5432"]
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./sql/init:/docker-entrypoint-initdb.d

  superset:
    image: apache/superset:latest
    container_name: superset
    restart: unless-stopped
    networks: [fxnet]
    depends_on: { postgres: { condition: service_healthy } }
    ports: ["8088:8088"]
    environment:
      - SUPERSET_SECRET_KEY=${SUPERSET_SECRET_KEY}
      - SUPERSET_LOAD_EXAMPLES=no
      - SQLALCHEMY_DATABASE_URI=postgresql+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
    volumes: [ "superset_home:/app/superset_home" ]
    command: >
      /bin/bash -c "
      superset db upgrade &&
      superset fab create-admin
        --username ${SUPERSET_ADMIN_USER}
        --firstname ${SUPERSET_ADMIN_FIRST}
        --lastname ${SUPERSET_ADMIN_LAST}
        --email ${SUPERSET_ADMIN_EMAIL}
        --password ${SUPERSET_ADMIN_PWD} &&
      superset init &&
      gunicorn -w 1 -k gevent --timeout 120 -b 0.0.0.0:8088 'superset.app:create_app()'
      "

  minio:
    image: minio/minio:latest
    container_name: minio
    restart: unless-stopped
    networks: [fxnet]
    ports: ["9000:9000","9001:9001"]
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    command: server /data --console-address ":9001"
    volumes: [ "minio_data:/data" ]

  ingestor:
    image: python:3.11-slim
    container_name: ingestor
    restart: unless-stopped
    networks: [fxnet]
    depends_on:
      - kafka
      - postgres
    environment:
      - KAFKA_BOOTSTRAP=kafka:19092
      - KAFKA_TOPIC=fx_rate_raw
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - ./ingestor:/app
    working_dir: /app
    command: /bin/sh -c "pip install -r requirements.txt && python app.py"

  yf_daily:
    image: python:3.11-slim
    container_name: yf_daily
    restart: unless-stopped
    networks: [fxnet]
    depends_on:
      - postgres
      - minio
    environment:
      - LOCAL_TZ=Asia/Seoul
      - RUN_AT=09:05                # 매일 09:05 KST에 실행
      - PAIRS=USDKRW
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - MINIO_ENDPOINT=http://minio:9000
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - MINIO_BUCKET=fx-raw
